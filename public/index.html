<!doctype html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Chamba F√°cil ‚Äî Encuentra y ofrece oficios cerca de ti</title>
  <meta name="description" content="Marketplace local de oficios: publica tu perfil y conecta por WhatsApp.">
  <meta name="theme-color" content="#f97316">
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#f97316">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config={theme:{extend:{colors:{primary:{500:'#f97316',600:'#ea580c'}}}}}</script>

  <!-- Leaflet (mapa) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
  <script>
    const FIREBASE_CONFIG={
      apiKey:"YOUR_API_KEY",
      authDomain:"YOUR_PROJECT.firebaseapp.com",
      projectId:"YOUR_PROJECT_ID",
      storageBucket:"YOUR_PROJECT.appspot.com",
      messagingSenderId:"SENDER_ID",
      appId:"APP_ID"
    };
    let db=null; try{ if(FIREBASE_CONFIG.apiKey!=='YOUR_API_KEY'){ firebase.initializeApp(FIREBASE_CONFIG); db=firebase.firestore(); } }catch(e){}
  </script>

  <!-- Cloudinary (mostrar im√°genes) -->
  <script>
    const CLOUDINARY_CLOUD_NAME="demo"; // cambia por tu cloud_name
    function cldImg(id,w=640){ return `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/image/upload/f_auto,q_auto,w_${w}/${id}.jpg`; }
    function cldSrcSet(id){ return [320,480,640,960,1200].map(w=>`${cldImg(id,w)} ${w}w`).join(','); }
  </script>
</head>
<body class="antialiased text-slate-800">
  <!-- Header -->
  <header class="fixed inset-x-0 top-0 z-50">
    <div class="mx-auto container px-4">
      <div class="mt-4 mb-3 flex items-center justify-between rounded-2xl bg-white/70 backdrop-blur px-4 py-3 shadow">
        <a href="#inicio" class="flex items-center gap-2 font-semibold">
          <span class="inline-flex h-9 w-9 items-center justify-center rounded-xl bg-primary-600 text-white">CF</span> Chamba F√°cil
        </a>
        <nav class="hidden gap-6 md:flex">
          <a href="#categorias" class="hover:text-primary-600">Categor√≠as</a>
          <a href="#oficios" class="hover:text-primary-600">Oficios</a>
          <a href="#precios" class="hover:text-primary-600">Plan</a>
          <a href="#pagos" class="hover:text-primary-600">Pagos</a>
        </nav>
        <a href="https://wa.me/524434813662" class="hidden md:inline-block rounded-xl bg-primary-600 px-4 py-2 text-white">WhatsApp</a>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section id="inicio" class="pt-40">
    <div class="mx-auto container px-4 grid gap-8 md:grid-cols-2 items-center">
      <div>
        <h1 class="text-4xl font-extrabold">Conecta con clientes y oficios locales con <span class="text-primary-600">Chamba F√°cil</span></h1>
        <p class="mt-4 text-slate-600">Publica tu perfil, sube tus fotos y aparece en el mapa ‚Äúcerca de m√≠‚Äù.</p>
        <div class="mt-6 flex gap-3">
          <a href="#pagos" class="rounded-xl bg-primary-600 px-6 py-3 text-white">Inscribirme</a>
          <a href="#categorias" class="rounded-xl border px-6 py-3">Ver categor√≠as</a>
        </div>
      </div>
      <img class="rounded-3xl shadow" src="https://images.unsplash.com/photo-1498050108023-c5249f4df085?q=80&w=1600&auto=format&fit=crop" alt="mockup">
    </div>
  </section>

  <!-- Categor√≠as -->
  <section id="categorias" class="py-10 bg-white">
    <div class="mx-auto container px-4">
      <h2 class="text-3xl font-bold text-center">Oficios por especialidad</h2>
      <p class="mt-2 text-center text-slate-600">Elige una categor√≠a para ver profesionales disponibles.</p>
      <div id="cat-grid" class="mt-6 grid gap-4 sm:grid-cols-2 md:grid-cols-4"></div>
    </div>
  </section>

  <!-- Oficios + mapa -->
  <section id="oficios" class="py-16 bg-slate-50">
    <div class="mx-auto container px-4">
      <h2 class="text-3xl font-bold text-center">Oficios</h2>

      <div class="mt-4 grid gap-3 md:grid-cols-3">
        <button id="btn-geo" class="rounded-xl border px-3 py-2">üìç Usar mi ubicaci√≥n</button>
        <label class="flex items-center gap-2 rounded-xl border px-3 py-2">Radio (km)
          <input id="radius" type="number" value="10" min="1" max="200" class="ml-2 w-24 rounded border px-2 py-1">
        </label>
        <button id="btn-apply" class="rounded-xl bg-primary-600 px-3 py-2 text-white">Aplicar filtro</button>
      </div>

      <div id="map" class="mt-4 h-80 w-full rounded-2xl border"></div>

      <div class="mt-6 flex items-center justify-between">
        <span id="page-label" class="text-sm text-slate-600">Cargando...</span>
        <div class="flex gap-2">
          <button id="prev-btn" class="rounded-xl border px-3 py-2 disabled:opacity-40" disabled>Anterior</button>
          <button id="next-btn" class="rounded-xl border px-3 py-2">Siguiente</button>
        </div>
      </div>
      <div id="profiles-list" class="mt-6 grid gap-6 sm:grid-cols-2 md:grid-cols-3"></div>
    </div>
  </section>

  <!-- Plan √∫nico -->
  <section id="precios" class="py-16">
    <div class="mx-auto container px-4">
      <h2 class="text-3xl font-bold text-center">Plan</h2>
      <div class="mt-8 grid gap-6 md:grid-cols-3">
        <div class="md:col-start-2 rounded-2xl border p-6 ring-2 ring-primary-600">
          <p class="text-sm text-primary-600">Inscripci√≥n anual</p>
          <h3 class="text-4xl font-extrabold">$150 <span class="text-base font-normal text-slate-500">MXN / a√±o</span></h3>
          <p class="mt-2 text-sm text-slate-600">Publica tu perfil por especialidad y aparece en el mapa cercano.</p>
          <a href="#pagos" class="mt-4 inline-block rounded-xl bg-primary-600 px-4 py-2 text-white">Elegir</a>
        </div>
      </div>
    </div>
  </section>

  <!-- Pagos -->
  <section id="pagos" class="py-16 bg-slate-50">
    <div class="mx-auto container px-4">
      <h2 class="text-3xl font-bold text-center">Portal de pagos</h2>
      <p class="mt-2 text-center text-slate-600">Transferencia (SPEI) y OXXO por Mercado Pago.</p>

      <div class="mt-8 grid gap-6 md:grid-cols-2">
        <!-- SPEI -->
        <div class="rounded-2xl border p-6 bg-white">
          <h3 class="text-xl font-semibold">Transferencia (SPEI)</h3>
          <p class="mt-2 text-sm text-slate-600">Realiza transferencia y env√≠a tu comprobante.</p>
          <div class="mt-3 text-sm">
            <p><strong>Banco:</strong> Banorte</p>
            <p><strong>Beneficiario:</strong> Eduardo D√≠az S√°nchez</p>
            <p><strong>CLABE:</strong> 072215006149433481
              <button type="button" class="ml-2 rounded border px-2 py-0.5 text-xs"
                onclick="navigator.clipboard.writeText('072215006149433481')">Copiar</button></p>
            <p><strong>Concepto:</strong> Inscripci√≥n anual Chamba F√°cil</p>
          </div>
          <form action="https://formsubmit.co/chambafacil8@gmail.com" method="POST" enctype="multipart/form-data" class="mt-3 grid gap-2">
            <input type="hidden" name="_subject" value="Comprobante ‚Äî Transferencia">
            <input type="hidden" name="_captcha" value="false">
            <input type="text" name="nombre" required placeholder="Tu nombre" class="rounded-xl border px-3 py-2">
            <input type="email" name="email" required placeholder="Tu correo" class="rounded-xl border px-3 py-2">
            <input type="file" name="comprobante" accept="image/*,application/pdf" class="rounded-xl border px-3 py-2">
            <button class="rounded-xl bg-primary-600 px-4 py-2 text-white hover:bg-primary-700">Enviar comprobante</button>
          </form>
        </div>

        <!-- OXXO / MP (plan √∫nico) -->
        <div class="rounded-2xl border p-6 bg-white">
          <h3 class="text-xl font-semibold">Pago en OXXO</h3>
          <p class="mt-2 text-sm text-slate-600">Se generar√° una referencia por Mercado Pago.</p>
          <div class="flex flex-col gap-2 mt-3">
            <button onclick="pagar('annual')" class="rounded-xl bg-primary-600 px-4 py-2 text-white">
              Inscripci√≥n anual ($150 MXN)
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <footer class="border-t py-10">
    <div class="mx-auto container px-4 flex items-center justify-between">
      <p class="text-sm">¬© <span id="year"></span> Chamba F√°cil.</p>
      <nav class="text-sm"><a href="/politica.html" class="hover:text-primary-600">Aviso de privacidad</a> ¬∑ <a href="/terminos.html" class="hover:text-primary-600">T√©rminos</a></nav>
    </div>
  </footer>

  <script>document.getElementById('year').textContent = new Date().getFullYear();</script>

  <!-- Mercado Pago SDK -->
  <script src="https://sdk.mercadopago.com/js/v2"></script>
  <script>
    // Reemplaza por tu Public Key de Mercado Pago
    const mp = new MercadoPago('PUBLIC_KEY_PLACEHOLDER', { locale: 'es-MX' });
    async function pagar(plan){
      const res = await fetch('/api/create-preference', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ plan })});
      const data = await res.json();
      if (data?.init_point || data?.sandbox_init_point) {
        location.href = data.init_point || data.sandbox_init_point;
      } else {
        alert('No se pudo crear la orden');
      }
    }
  </script>

  <script>
    // ====== Categor√≠as ======
    const CATEGORIES = ["Alba√±iler√≠a","Jardiner√≠a","Plomer√≠a","Electricidad","Mec√°nicos","Estilistas","Cerrajeros","Zapateros"];
    let activeCategory = null;

    function renderCategories(){
      const grid = document.getElementById('cat-grid');
      grid.innerHTML = CATEGORIES.map(cat => `
        <article class="rounded-2xl border p-4 bg-white flex flex-col">
          <h3 class="text-lg font-semibold">${cat}</h3>
          <p class="mt-1 text-sm text-slate-600">Profesionales cerca de ti.</p>
          <button class="mt-auto rounded-xl bg-primary-600 px-3 py-2 text-white" onclick="entrarCategoria('${cat}')">Entrar</button>
        </article>
      `).join('');
    }
    function entrarCategoria(cat){
      activeCategory = cat;
      document.querySelector('#oficios').scrollIntoView({behavior:'smooth', block:'start'});
      applyFilterByCategory();
    }
  </script>

  <script>
    // ====== Geocerca con Leaflet ======
    let userLoc = null;   // {lat,lng}
    let map, userMarker, markersLayer;
    const PAGE_SIZE = 12; let page=1; let lastItems=[];

    function distKm(a,b){ const toRad=d=>d*Math.PI/180, R=6371;
      const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
      const sa=Math.sin(dLat/2), sb=Math.sin(dLng/2);
      const A=sa*sa + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*sb*sb;
      return 2*R*Math.atan2(Math.sqrt(A),Math.sqrt(1-A));
    }
    function ensureMap(){
      if (map) return;
      map = L.map('map').setView([19.7008, -101.1844], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
    }
    function updateMap(user, items){
      ensureMap(); markersLayer.clearLayers();
      if (user){
        if (userMarker) markersLayer.removeLayer(userMarker);
        userMarker = L.marker([user.lat, user.lng], { title:'T√∫' }).addTo(markersLayer).bindPopup('Tu ubicaci√≥n');
      }
      for (const p of items){
        if (!p.location || typeof p.location.lat!=='number') continue;
        const m=L.marker([p.location.lat,p.location.lng], {title:p.name||'Oficio'});
        m.bindPopup(`<strong>${p.name||'Oficio'}</strong><br>${p.oficio||''} ¬∑ ${p.ciudad||''}`);
        markersLayer.addLayer(m);
      }
      const group=L.featureGroup(markersLayer.getLayers());
      try{ map.fitBounds(group.getBounds().pad(0.2)); }catch(e){}
    }
    function getGeolocation(){ return new Promise((res,rej)=>{
      if (!navigator.geolocation) return rej(new Error('Geolocalizaci√≥n no disponible'));
      navigator.geolocation.getCurrentPosition(p=>res({lat:p.coords.latitude,lng:p.coords.longitude}), rej, {enableHighAccuracy:true, timeout:10000, maximumAge:0});
    }); }

    async function fetchProfiles(limit=200){
      if (window.db){
        const snap = await db.collection('profiles').orderBy('createdAt','desc').limit(limit).get();
        return snap.docs.map(d=>d.data());
      }
      // Fallback (sin coords reales)
      return Array.from({length:24}).map((_,i)=>({name:`Oficio ${i+1}`, oficio:'Varios', ciudad:'', photos:['sample'], rating:4.5}));
    }
    async function fetchProfilesByCategory(cat, limit=200){
      if (!cat) return fetchProfiles(limit);
      if (window.db){
        const snap = await db.collection('profiles').where('oficio','==',cat).limit(limit).get();
        return snap.docs.map(d=>d.data());
      } else {
        const all = await fetchProfiles(limit);
        return all.filter(p => (p.oficio||'').toLowerCase() === cat.toLowerCase());
      }
    }

    function renderSlice(items){
      lastItems = items || [];
      const list = document.getElementById('profiles-list');
      list.innerHTML = lastItems.map((p,i)=>{
        const img = p.photos?.[0] || 'sample';
        return `<article class="rounded-2xl border overflow-hidden bg-white">
          <img loading="lazy" class="h-48 w-full object-cover" src="${cldImg(img,640)}" srcset="${cldSrcSet(img)}" sizes="(max-width:640px) 100vw, 33vw" alt="${p.oficio||'Oficio'}">
          <div class="p-4">
            <h3 class="font-semibold">${p.name||'Perfil'}</h3>
            <p class="text-sm text-slate-600">${p.oficio||''} ¬∑ ${p.ciudad||''}</p>
            <div class="mt-3 flex gap-2">
              <a href="https://wa.me/524434813662" class="rounded-xl bg-primary-600 px-3 py-2 text-white">Contactar</a>
              <button class="rounded-xl border px-3 py-2" onclick="verEnMapa(${i})">Ver en mapa</button>
            </div>
          </div>
        </article>`;
      }).join('');
    }

    function verEnMapa(i){
      const p = lastItems[i];
      if (!p || !p.location || typeof p.location.lat!=='number' || typeof p.location.lng!=='number'){
        alert('Este perfil a√∫n no tiene ubicaci√≥n registrada.');
        return;
      }
      ensureMap();
      const latlng = [p.location.lat, p.location.lng];
      map.setView(latlng, 15);
      L.popup().setLatLng(latlng).setContent(`<strong>${p.name||'Oficio'}</strong><br>${p.oficio||''} ¬∑ ${p.ciudad||''}`).openOn(map);
      document.getElementById('map').scrollIntoView({ behavior:'smooth', block:'center' });
    }

    async function applyNearMe(){
      const radiusKm = Number(document.getElementById('radius').value || 10);
      const all = await fetchProfiles(200);
      let filtered = all;
      if (userLoc){
        filtered = all
          .filter(p => p.location && typeof p.location.lat==='number' && typeof p.location.lng==='number')
          .map(p => ({ ...p, __d: distKm(userLoc, {lat:p.location.lat, lng:p.location.lng}) }))
          .filter(p => p.__d <= radiusKm)
          .sort((a,b)=>a.__d - b.__d);
      }
      renderSlice(filtered.slice(0,PAGE_SIZE));
      document.getElementById('page-label').textContent = userLoc ? `Resultados a ${radiusKm} km (ordenados por cercan√≠a)` : `√öltimos perfiles`;
      updateMap(userLoc, filtered.slice(0,50));
    }

    async function applyFilterByCategory(){
      const radiusKm = Number(document.getElementById('radius').value || 10);
      const base = await fetchProfilesByCategory(activeCategory, 200);
      let filtered = base;
      if (userLoc){
        filtered = base
          .filter(p => p.location && typeof p.location.lat==='number' && typeof p.location.lng==='number')
          .map(p => ({ ...p, __d: distKm(userLoc, {lat:p.location.lat, lng:p.location.lng}) }))
          .filter(p => p.__d <= radiusKm)
          .sort((a,b)=>a.__d - b.__d);
      }
      renderSlice(filtered.slice(0,PAGE_SIZE));
      document.getElementById('page-label').textContent = (activeCategory? activeCategory : 'Todos') + (userLoc? ` ¬∑ a ${radiusKm} km` : '');
      updateMap(userLoc, filtered.slice(0,50));
    }

    document.getElementById('btn-geo').onclick = async () => {
      try{ userLoc = await getGeolocation(); ensureMap(); map.setView([userLoc.lat,userLoc.lng], 13); }
      catch(e){ alert('Activa tu ubicaci√≥n y vuelve a intentar.'); }
      if (activeCategory) applyFilterByCategory(); else applyNearMe();
    };
    document.getElementById('btn-apply').onclick = () => { if (activeCategory) applyFilterByCategory(); else applyNearMe(); };

    function getGeolocation(){ return new Promise((res,rej)=>{
      if (!navigator.geolocation) return rej(new Error('Geolocalizaci√≥n no disponible'));
      navigator.geolocation.getCurrentPosition(p=>res({lat:p.coords.latitude,lng:p.coords.longitude}), rej, {enableHighAccuracy:true, timeout:10000});
    }); }

    function ensureStartup(){
      renderCategories();
      ensureMap();
      applyNearMe();
      document.getElementById('prev-btn').onclick = ()=>{}; // paginaci√≥n desactivada en modo Firestore/filtrado simple
      document.getElementById('next-btn').onclick = ()=>{};
    }
    window.addEventListener('DOMContentLoaded', ensureStartup);
  </script>
</body>
</html>
