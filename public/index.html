<!doctype html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Chamba F√°cil ‚Äî Oficios cerca de ti | Publica tu perfil</title>
  <meta name="description" content="Encuentra y ofrece oficios locales. Publica tu perfil con fotos, recibe clientes por WhatsApp y aparece en el mapa cerca de m√≠. Inscripci√≥n anual $150 MXN.">
  <meta name="theme-color" content="#f97316">
  <link id="canonical" rel="canonical" href="https://chambafacil.app/">
  <meta http-equiv="Content-Language" content="es-MX">

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-RY7GC75EPC"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-RY7GC75EPC');
  </script>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: { primary: {500:'#f97316',600:'#ea580c',700:'#c2410c'} } } } }
  </script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Firebase (opcional, listo para conectar despu√©s) -->
  <script defer src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
  <script>
    const FIREBASE_CONFIG={
      apiKey:"YOUR_API_KEY",
      authDomain:"YOUR_PROJECT.firebaseapp.com",
      projectId:"YOUR_PROJECT_ID",
      storageBucket:"YOUR_PROJECT.appspot.com",
      messagingSenderId:"SENDER_ID",
      appId:"APP_ID"
    };
    let db=null; document.addEventListener('DOMContentLoaded',()=>{
      try{ if(FIREBASE_CONFIG.apiKey!=='YOUR_API_KEY' && window.firebase){
        if(!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
        db=firebase.firestore();
      }}catch(e){}
    });
  </script>

  <style>
    :focus-visible { outline: 3px solid #ea580c; outline-offset: 2px; }
    .skip-link{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;}
    .skip-link:focus{left:1rem;top:1rem;width:auto;height:auto;background:#fff;padding:.5rem 1rem;border-radius:.5rem;box-shadow:0 1px 6px rgba(0,0,0,.15)}
    .modal-backdrop{ position: fixed; inset: 0; background: rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index: 60; }
    .modal{ background:#fff; border-radius: 1rem; max-width: 960px; width: 95%; max-height: 90vh; overflow: auto; }
    .modal.open{ display:flex; }
    .nav-active { color:#ea580c !important; font-weight:600 }
  </style>
</head>
<body class="antialiased text-slate-800">
  <a href="#inicio" class="skip-link">Saltar al contenido</a>

  <header class="fixed inset-x-0 top-0 z-50" role="banner">
    <div class="mx-auto container px-4">
      <div class="mt-4 mb-3 flex items-center justify-between rounded-2xl bg-white/90 backdrop-blur px-4 py-3 shadow">
        <a href="#inicio" class="flex items-center gap-2 font-semibold" aria-label="Ir al inicio">
          <span aria-hidden="true" class="inline-flex h-9 w-9 items-center justify-center rounded-xl bg-primary-600 text-white">CF</span> Chamba F√°cil
        </a>
        <nav class="hidden gap-6 md:flex" aria-label="Navegaci√≥n principal">
          <a id="lnk-categorias" href="#categorias" class="hover:text-primary-600">Categor√≠as</a>
          <a id="lnk-oficios" href="#oficios" class="hover:text-primary-600">Oficios</a>
          <a id="lnk-precios" href="#precios" class="hover:text-primary-600">Plan</a>
          <a id="lnk-pagos" href="#pagos" class="hover:text-primary-600">Pagos</a>
        </nav>
        <div class="flex gap-2">
          <a href="/admin.html" class="hidden md:inline-block rounded-xl border px-4 py-2">Crear mi perfil</a>
          <a href="https://wa.me/524434813662" class="hidden md:inline-block rounded-xl bg-primary-600 px-4 py-2 text-white" aria-label="Contactar por WhatsApp">WhatsApp</a>
        </div>
      </div>
    </div>
  </header>

  <main id="inicio" class="pt-40" role="main">
    <div class="mx-auto container px-4 grid gap-8 md:grid-cols-2 items-center">
      <div>
        <h1 class="text-4xl font-extrabold">Conecta con clientes y oficios locales con <span class="text-primary-600">Chamba F√°cil</span></h1>
        <p class="mt-4 text-slate-700">Publica tu perfil, sube tus fotos y aparece en el mapa ‚Äúcerca de m√≠‚Äù.</p>
        <div class="mt-6 flex gap-3 flex-wrap">
          <a href="/admin.html" class="rounded-xl bg-primary-600 px-6 py-3 text-white" aria-label="Crear mi perfil ahora">Crear mi perfil</a>
          <a href="#pagos" class="rounded-xl border px-6 py-3">Inscribirme</a>
          <a href="#categorias" class="rounded-xl border px-6 py-3">Ver categor√≠as</a>
        </div>
      </div>
      <img class="rounded-3xl shadow" src="https://images.unsplash.com/photo-1498050108023-c5249f4df085?q=80&w=1600&auto=format&fit=crop" alt="Personas trabajando en oficios" loading="lazy">
    </div>
  </main>

  <section id="valor" class="py-12">
    <div class="mx-auto container px-4 text-center">
      <h2 class="text-3xl font-bold text-gray-800 mb-2">¬øPor qu√© elegir <span class="text-primary-600">Chamba F√°cil</span>?</h2>
      <p class="text-lg text-gray-600 mb-8">Conecta con m√°s clientes locales y crece tu trabajo en minutos.</p>
      <div class="grid md:grid-cols-3 gap-6 text-gray-700">
        <button type="button" onclick="goTo('map')" class="p-5 bg-white rounded-2xl shadow-sm hover:shadow-md transition border text-left w-full cursor-pointer focus:outline-none focus:ring-2 focus:ring-primary-600" aria-describedby="b1d">
          <div aria-hidden="true" class="text-4xl">üìç</div>
          <h3 class="font-semibold text-xl mt-2">Mapa cerca de m√≠</h3>
          <p id="b1d" class="text-slate-600">Encuentra y ofrece servicios con ubicaci√≥n real, visibles en tu zona.</p>
        </button>
        <button type="button" onclick="goTo('pagos')" class="p-5 bg-white rounded-2xl shadow-sm hover:shadow-md transition border text-left w-full cursor-pointer focus:outline-none focus:ring-2 focus:ring-primary-600" aria-describedby="b2d">
          <div aria-hidden="true" class="text-4xl">‚ö°</div>
          <h3 class="font-semibold text-xl mt-2">Publica en 2 minutos</h3>
          <p id="b2d" class="text-slate-600">Crea tu perfil r√°pido, sube fotos y empieza a recibir clientes hoy.</p>
        </button>
        <button type="button" onclick="goTo('categorias')" class="p-5 bg-white rounded-2xl shadow-sm hover:shadow-md transition border text-left w-full cursor-pointer focus:outline-none focus:ring-2 focus:ring-primary-600" aria-describedby="b3d">
          <div aria-hidden="true" class="text-4xl">ü§ù</div>
          <h3 class="font-semibold text-xl mt-2">+ Clientes locales</h3>
          <p id="b3d" class="text-slate-600">Personas cercanas te encuentran f√°cil y te contactan por WhatsApp.</p>
        </button>
      </div>
    </div>
  </section>

  <section id="testimonios" class="bg-slate-50 py-12" aria-labelledby="titulotest">
    <div class="mx-auto container px-4 text-center">
      <h2 id="titulotest" class="text-3xl font-bold text-gray-800 mb-6">Lo que dicen nuestros usuarios</h2>
      <div class="grid md:grid-cols-3 gap-6 text-gray-700">
        <figure class="bg-white p-6 rounded-2xl shadow-sm">
          <blockquote class="italic text-slate-700">‚ÄúCon Chamba F√°cil me contactaron m√°s clientes en una semana que en todo un mes.‚Äù</blockquote>
          <figcaption class="mt-3 font-semibold text-primary-600">‚Äî Luis, Plomero</figcaption>
        </figure>
        <figure class="bg-white p-6 rounded-2xl shadow-sm">
          <blockquote class="italic text-slate-700">‚ÄúPuse mi ubicaci√≥n y fotos; mis clientas llegan solas.‚Äù</blockquote>
          <figcaption class="mt-3 font-semibold text-primary-600">‚Äî Karina, Estilista</figcaption>
        </figure>
        <figure class="bg-white p-6 rounded-2xl shadow-sm">
          <blockquote class="italic text-slate-700">‚ÄúPago anual y aparezco en el mapa. Justo lo que necesitaba.‚Äù</blockquote>
          <figcaption class="mt-3 font-semibold text-primary-600">‚Äî Jos√©, Electricista</figcaption>
        </figure>
      </div>
    </div>
  </section>

  <section id="categorias" class="py-10 bg-white" aria-labelledby="titcat">
    <div class="mx-auto container px-4">
      <h2 id="titcat" class="text-3xl font-bold text-center">Oficios por especialidad</h2>
      <p class="mt-2 text-center text-slate-700">Elige una categor√≠a para ver profesionales disponibles.</p>
      <div id="cat-grid" class="mt-6 grid gap-4 sm:grid-cols-2 md:grid-cols-4"></div>
    </div>
  </section>

  <section id="oficios" class="py-16 bg-slate-50" aria-labelledby="titofi">
    <div class="mx-auto container px-4">
      <h2 id="titofi" class="text-3xl font-bold text-center">Oficios</h2>

      <div class="mt-4 grid gap-3 md:grid-cols-3">
        <button id="btn-geo" class="rounded-xl border px-4 py-3" aria-label="Usar mi ubicaci√≥n">üìç Usar mi ubicaci√≥n</button>
        <label class="flex items-center gap-2 rounded-xl border px-3 py-2" for="radius">Radio (km)
          <input id="radius" type="number" value="10" min="1" max="200" class="ml-2 w-24 rounded border px-2 py-2" aria-describedby="rdhelp">
        </label>
        <span id="rdhelp" class="sr-only">Distancia de b√∫squeda en kil√≥metros</span>
        <button id="btn-apply" class="rounded-xl bg-primary-600 px-4 py-3 text-white">Aplicar filtro</button>
      </div>

      <div id="map" class="mt-4 h-80 w-full rounded-2xl border" role="region" aria-label="Mapa de profesionales cerca de ti"></div>

      <p id="empty-state" class="hidden mt-6 text-center text-slate-700" aria-live="polite"></p>

      <div class="mt-6 flex items-center justify-between">
        <span id="page-label" class="text-sm text-slate-700">Cargando...</span>
        <div class="flex gap-2">
          <button id="prev-btn" class="rounded-xl border px-4 py-2 disabled:opacity-40" disabled>Anterior</button>
          <button id="next-btn" class="rounded-xl border px-4 py-2">Siguiente</button>
        </div>
      </div>
      <div id="profiles-list" class="mt-6 grid gap-6 sm:grid-cols-2 md:grid-cols-3"></div>
    </div>
  </section>

  <section id="precios" class="py-16" aria-labelledby="titplan">
    <div class="mx-auto container px-4">
      <h2 id="titplan" class="text-3xl font-bold text-center">Plan</h2>
      <div class="mt-8 grid gap-6 md:grid-cols-3">
        <div class="md:col-start-2 rounded-2xl border p-6 ring-2 ring-primary-600">
          <p class="text-sm text-primary-600">Inscripci√≥n anual</p>
          <h3 class="text-4xl font-extrabold">$150 <span class="text-base font-normal text-slate-500">MXN / a√±o</span></h3>
          <p class="mt-2 text-sm text-slate-700">Publica tu perfil por especialidad y aparece en el mapa cercano.</p>
          <a href="#pagos" class="mt-4 inline-block rounded-xl bg-primary-600 px-4 py-2 text-white">Elegir</a>
        </div>
      </div>
    </div>
  </section>

  <section id="pagos" class="py-16 bg-slate-50" aria-labelledby="titpagos">
    <div class="mx-auto container px-4">
      <h2 id="titpagos" class="text-3xl font-bold text-center">Portal de pagos</h2>
      <p class="mt-2 text-center text-slate-700">Transferencia (SPEI) y OXXO (pr√≥ximamente Mercado Pago).</p>

      <div class="mt-8 grid gap-6 md:grid-cols-2">
        <div class="rounded-2xl border p-6 bg-white">
          <h3 class="text-xl font-semibold">Transferencia (SPEI)</h3>
          <p class="mt-2 text-sm text-slate-700">Realiza transferencia y env√≠a tu comprobante.</p>
          <div class="mt-3 text-sm">
            <p><strong>Banco:</strong> Banorte</p>
            <p><strong>Beneficiario:</strong> Eduardo D√≠az S√°nchez</p>
            <p><strong>CLABE:</strong> 072215006149433481
              <button type="button" class="ml-2 rounded border px-2 py-1 text-xs"
                onclick="navigator.clipboard.writeText('072215006149433481')">Copiar</button></p>
            <p><strong>Concepto:</strong> Inscripci√≥n anual Chamba F√°cil</p>
          </div>
          <form action="https://formsubmit.co/chambafacil8@gmail.com" method="POST" enctype="multipart/form-data" class="mt-3 grid gap-2" aria-label="Enviar comprobante de pago por transferencia">
            <input type="hidden" name="_subject" value="Comprobante ‚Äî Transferencia">
            <input type="hidden" name="_captcha" value="false">
            <label class="sr-only" for="f-nombre">Nombre</label>
            <input id="f-nombre" type="text" name="nombre" required placeholder="Tu nombre" class="rounded-xl border px-3 py-3">
            <label class="sr-only" for="f-email">Correo</label>
            <input id="f-email" type="email" name="email" required placeholder="Tu correo" class="rounded-xl border px-3 py-3">
            <label class="sr-only" for="f-comp">Archivo comprobante</label>
            <input id="f-comp" type="file" name="comprobante" accept="image/*,application/pdf" class="rounded-xl border px-3 py-2">
            <button class="rounded-xl bg-primary-600 px-4 py-3 text-white hover:bg-primary-700">Enviar comprobante</button>
          </form>
        </div>

        <div class="rounded-2xl border p-6 bg-white">
          <h3 class="text-xl font-semibold">Pago en OXXO</h3>
          <p class="mt-2 text-sm text-slate-700">Se habilitar√° con Mercado Pago.</p>
          <div class="flex flex-col gap-2 mt-3">
            <button onclick="pagar('annual')" class="rounded-xl bg-primary-600 px-4 py-3 text-white" aria-label="Pagar inscripci√≥n anual">
              Inscripci√≥n anual ($150 MXN)
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <footer class="border-t py-10" role="contentinfo">
    <div class="mx-auto container px-4 flex items-center justify-between">
      <p class="text-sm">¬© <span id="year"></span> Chamba F√°cil.</p>
      <nav class="text-sm" aria-label="Legales"><a href="/politica.html" class="hover:text-primary-600">Aviso de privacidad</a> ¬∑ <a href="/terminos.html" class="hover:text-primary-600">T√©rminos</a></nav>
    </div>
  </footer>

  <div id="perfil-modal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="perfil-title">
    <div class="modal p-4 md:p-6">
      <div class="flex justify-between items-center border-b pb-3">
        <h3 id="perfil-title" class="text-xl font-semibold">Perfil</h3>
        <button onclick="closePerfil()" class="rounded-lg border px-3 py-1" aria-label="Cerrar modal">Cerrar</button>
      </div>
      <div class="grid md:grid-cols-2 gap-4 mt-4">
        <div class="space-y-3">
          <p class="text-slate-700"><strong>Oficio: </strong><span id="perfil-oficio">‚Äî</span></p>
          <p class="text-slate-700"><strong>Ciudad: </strong><span id="perfil-ciudad">‚Äî</span></p>
          <p class="class=text-slate-700"><strong>Descripci√≥n: </strong><span id="perfil-desc">‚Äî</span></p>
          <div class="flex gap-2 mt-3">
            <a id="perfil-whatsapp" target="_blank" class="rounded-xl bg-primary-600 px-4 py-2 text-white">Contactar por WhatsApp</a>
            <button id="perfil-ver-mapa" class="rounded-xl border px-4 py-2">Ver en mapa</button>
          </div>
        </div>
        <div class="grid grid-cols-3 gap-2" id="perfil-fotos"></div>
      </div>
    </div>
  </div>

  <script>document.getElementById('year').textContent = new Date().getFullYear();</script>
  <script>function pagar(plan){ location.href = '/pago-previo.html'; }</script>

  <script>
    const CATEGORIES = ["Alba√±iler√≠a","Jardiner√≠a","Plomer√≠a","Electricidad","Mec√°nicos","Estilistas","Cerrajeros","Zapateros"];
    let activeCategory = null;
    let allProfilesCache = [];

    async function fetchProfiles(limit=300){
      if (window.db){
        const snap = await db.collection('profiles').orderBy('createdAt','desc').limit(limit).get();
        return snap.docs.map(d=>d.data());
      }
      return Array.from({length:12}).map((_,i)=>({name:`Oficio ${i+1}`, oficio:CATEGORIES[i%8], ciudad:'', photos:['sample'], rating:4.5}));
    }

    function computeCounts(profiles){
      const counts = Object.fromEntries(CATEGORIES.map(c=>[c,0]));
      for(const p of profiles){
        const cat = (p.oficio||'').trim();
        if (counts.hasOwnProperty(cat)) counts[cat]++;
      }
      return counts;
    }

    function renderCategories(counts){
      const grid = document.getElementById('cat-grid');
      grid.innerHTML = CATEGORIES.map(cat => {
        const n = counts?.[cat] ?? 0;
        return `
        <article class="rounded-2xl border p-4 bg-white flex flex-col">
          <h3 class="text-lg font-semibold">${cat} <span class="text-slate-500 text-sm">(${n})</span></h3>
          <p class="mt-1 text-sm text-slate-600">Profesionales cerca de ti.</p>
          <a href="#oficios" class="mt-auto rounded-xl bg-primary-600 px-3 py-2 text-white text-center"
             onclick="entrarCategoria('${cat}'); return false;">Entrar</a>
        </article>`;
      }).join('');
    }

    function entrarCategoria(cat){
      activeCategory = cat;
      applyFilterByCategory();
      const oficios = document.getElementById('oficios');
      if (oficios) oficios.scrollIntoView({ behavior:'smooth', block:'start' });
    }
  </script>

  <script>
    let userLoc = null;
    let map, userMarker, markersLayer;
    const PAGE_SIZE = 12; let lastItems=[];

    function distKm(a,b){ const toRad=d=>d*Math.PI/180, R=6371;
      const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
      const sa=Math.sin(dLat/2), sb=Math.sin(dLng/2);
      const A=sa*sa + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*sb*sb;
      return 2*R*Math.atan2(Math.sqrt(A),Math.sqrt(1-A));
    }
    function ensureMap(){
      if (map) return;
      map = L.map('map').setView([19.7008, -101.1844], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
    }
    function updateMap(user, items){
      ensureMap(); markersLayer.clearLayers();
      if (user){
        if (userMarker) markersLayer.removeLayer(userMarker);
        userMarker = L.marker([user.lat, user.lng], { title:'T√∫' }).addTo(markersLayer).bindPopup('Tu ubicaci√≥n');
      }
      for (const p of items){
        if (!p.location || typeof p.location.lat!=='number') continue;
        const m=L.marker([p.location.lat, p.location.lng], {title:p.name||'Oficio'});
        m.bindPopup(`<strong>${p.name||'Oficio'}</strong><br>${p.oficio||''} ¬∑ ${p.ciudad||''}`);
        markersLayer.addLayer(m);
      }
      const group=L.featureGroup(markersLayer.getLayers());
      try{ map.fitBounds(group.getBounds().pad(0.2)); }catch(e){}
    }

    function renderSlice(items){
      lastItems = items || [];
      const list = document.getElementById('profiles-list');
      const empty = document.getElementById('empty-state');

      if (!lastItems.length){
        const catTxt = activeCategory ? activeCategory.toLowerCase() : "esta b√∫squeda";
        const radiusKm = Number(document.getElementById('radius').value || 10);
        empty.textContent = `A√∫n no hay ${catTxt} cerca, prueba ampliar el radio (actual: ${radiusKm} km).`;
        empty.classList.remove('hidden');
      } else {
        empty.classList.add('hidden');
      }

      list.innerHTML = lastItems.map((p,i)=>{
        const img = p.photos?.[0] || 'sample';
        const phone = (p.phone || '524434813662').replace(/\D+/g,'');
        return `<article class="rounded-2xl border overflow-hidden bg-white">
          <img loading="lazy" class="h-48 w-full object-cover" src="https://res.cloudinary.com/demo/image/upload/f_auto,q_auto,w_640/${img}.jpg" alt="${p.oficio||'Oficio'}">
          <div class="p-4">
            <h3 class="font-semibold">${p.name||'Perfil'}</h3>
            <p class="text-sm text-slate-700">${p.oficio||''} ¬∑ ${p.ciudad||''}</p>
            <div class="mt-3 flex gap-2">
              <a href="https://wa.me/${phone}" class="rounded-xl bg-primary-600 px-3 py-2 text-white">Contactar</a>
              <button class="rounded-xl border px-3 py-2" onclick="verEnMapa(${i})">Ver en mapa</button>
              <button class="rounded-xl border px-3 py-2" onclick="verPerfil(${i})">Ver perfil</button>
            </div>
          </div>
        </article>`;
      }).join('');
    }

    function verEnMapa(i){
      const p = lastItems[i];
      if (!p || !p.location || typeof p.location.lat!=='number' || typeof p.location.lng!=='number'){
        alert('Este perfil a√∫n no tiene ubicaci√≥n registrada.');
        return;
      }
      ensureMap();
      const latlng = [p.location.lat, p.location.lng];
      map.setView(latlng, 15);
      L.popup().setLatLng(latlng).setContent(`<strong>${p.name||'Oficio'}</strong><br>${p.oficio||''} ¬∑ ${p.ciudad||''}`).openOn(map);
      document.getElementById('map').scrollIntoView({ behavior:'smooth', block:'center' });
    }

    function verPerfil(i){
      const p = lastItems[i]; if (!p) return;
      document.getElementById('perfil-title').textContent = p.name || 'Perfil';
      document.getElementById('perfil-oficio').textContent = p.oficio || '‚Äî';
      document.getElementById('perfil-ciudad').textContent = p.ciudad || '‚Äî';
      document.getElementById('perfil-desc').textContent = p.descripcion || p.bio || '‚Äî';
      const phone = (p.phone || '524434813662').replace(/\D+/g,'');
      document.getElementById('perfil-whatsapp').href = `https://wa.me/${phone}`;
      const fotos = (p.photos || []).slice(0,3);
      const wrap = document.getElementById('perfil-fotos');
      wrap.innerHTML = (fotos.length ? fotos : ['sample','sample','sample']).map(id => `
        <img class="w-full h-28 object-cover rounded-lg" src="https://res.cloudinary.com/demo/image/upload/f_auto,q_auto,w_480/${id}.jpg" alt="Foto del trabajo">
      `).join('');
      const btnMapa = document.getElementById('perfil-ver-mapa');
      btnMapa.onclick = () => {
        closePerfil();
        const idx = lastItems.indexOf(p);
        if (idx>=0) verEnMapa(idx);
      }
      openPerfil();
    }

    function openPerfil(){ document.getElementById('perfil-modal').classList.add('open'); }
    function closePerfil(){ document.getElementById('perfil-modal').classList.remove('open'); }

    function distFilter(items, radiusKm){
      if (!userLoc) return items;
      return items
        .filter(p => p.location && typeof p.location.lat==='number' && typeof p.location.lng==='number')
        .map(p => ({ ...p, __d: distKm(userLoc, {lat:p.location.lat, lng:p.location.lng}) }))
        .filter(p => p.__d <= radiusKm)
        .sort((a,b)=>a.__d - b.__d);
    }

    async function applyNearMe(){
      const radiusKm = Number(document.getElementById('radius').value || 10);
      let base = activeCategory ? await fetchByCategory(activeCategory) : allProfilesCache;
      const filtered = distFilter(base, radiusKm);
      renderSlice(filtered.slice(0, 12));
      document.getElementById('page-label').textContent = userLoc ? `Resultados a ${radiusKm} km (ordenados por cercan√≠a)` : `√öltimos perfiles`;
      updateMap(userLoc, filtered.slice(0,50));
    }

    async function fetchByCategory(cat, limit=300){
      if (!cat){ return allProfilesCache; }
      if (window.db){
        const snap = await db.collection('profiles').where('oficio','==',cat).limit(limit).get();
        return snap.docs.map(d=>d.data());
      }
      return allProfilesCache.filter(p => (p.oficio||'').toLowerCase()===cat.toLowerCase());
    }

    async function applyFilterByCategory(){
      const radiusKm = Number(document.getElementById('radius').value || 10);
      let base = await fetchByCategory(activeCategory);
      const filtered = distFilter(base, radiusKm);
      renderSlice(filtered.slice(0, 12));
      document.getElementById('page-label').textContent = (activeCategory? activeCategory : 'Todos') + (userLoc? ` ¬∑ a ${radiusKm} km` : '');
      updateMap(userLoc, filtered.slice(0,50));
    }

    document.getElementById('btn-geo').onclick = async () => {
      try{ userLoc = await new Promise((res,rej)=>{
        if (!navigator.geolocation) return rej(new Error('Geolocalizaci√≥n no disponible'));
        navigator.geolocation.getCurrentPosition(p=>res({lat:p.coords.latitude,lng:p.coords.longitude}), rej, {enableHighAccuracy:true, timeout:10000, maximumAge:0});
      }); ensureMap(); map.setView([userLoc.lat,userLoc.lng], 13); }
      catch(e){ alert('Activa tu ubicaci√≥n y vuelve a intentar.'); }
      if (activeCategory) applyFilterByCategory(); else applyNearMe();
    };
    document.getElementById('btn-apply').onclick = () => { if (activeCategory) applyFilterByCategory(); else applyNearMe(); };

    const sections = [
      { id:'categorias', link: document.getElementById('lnk-categorias') },
      { id:'oficios', link: document.getElementById('lnk-oficios') },
      { id:'precios', link: document.getElementById('lnk-precios') },
      { id:'pagos', link: document.getElementById('lnk-pagos') },
    ];
    const io = new IntersectionObserver((entries)=>{
      entries.forEach(e=>{
        const sec = sections.find(s=>s.id===e.target.id);
        if (!sec) return;
        if (e.isIntersecting){ sections.forEach(s=>s.link?.classList.remove('nav-active')); sec.link?.classList.add('nav-active'); }
      });
    },{ rootMargin: '-40% 0px -55% 0px', threshold: 0.01 });
    sections.forEach(s=>{ const el=document.getElementById(s.id); if(el) io.observe(el); });

    async function startup(){
      allProfilesCache = await fetchProfiles(300);
      const counts = computeCounts(allProfilesCache);
      renderCategories(counts);
      ensureMap();
      applyNearMe();
    }
    window.addEventListener('DOMContentLoaded', startup);
  </script>
</body>
</html>
