<!doctype html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chamba F√°cil ‚Äî Crear mi perfil</title>
  <meta name="description" content="Registra tu perfil para aparecer por especialidad y en el mapa cerca de m√≠. Sube fotos, marca tu ubicaci√≥n y deja tu comprobante de pago." />
  <meta name="theme-color" content="#f97316" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { primary: { 500:'#f97316', 600:'#ea580c', 700:'#c2410c' } }
        }
      }
    }
  </script>

  <!-- Leaflet (mapa) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

  <!-- Firebase (defer) -->
  <script defer src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

  <!-- Configuraci√≥n Firebase (reemplaza por la tuya) -->
  <script>
    const FIREBASE_CONFIG = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };
    let db = null;
    // La inicializaci√≥n real ocurrir√° cuando el navegador haya cargado los scripts defer.
    document.addEventListener('DOMContentLoaded', () => {
      try {
        if (FIREBASE_CONFIG.apiKey !== 'YOUR_API_KEY') {
          if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
          db = firebase.firestore();
        }
      } catch (e) { console.warn('Firebase no inicializado:', e); }
    });
  </script>

  <!-- Cloudinary Unsigned Upload (reemplaza por los tuyos) -->
  <script>
    const CLOUDINARY_CLOUD_NAME = "YOUR_CLOUD_NAME";
    const CLOUDINARY_UNSIGNED_PRESET = "YOUR_UNSIGNED_PRESET";

    async function uploadToCloudinary(file, folder='chambafacil/profiles') {
      const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`;
      const fd = new FormData();
      fd.append('file', file);
      fd.append('upload_preset', CLOUDINARY_UNSIGNED_PRESET);
      fd.append('folder', folder);
      const res = await fetch(url, { method: 'POST', body: fd });
      if (!res.ok) throw new Error('Fallo al subir a Cloudinary');
      return await res.json(); // { public_id, secure_url, ... }
    }
  </script>

  <style>
    .leaflet-container { border-radius: 1rem; }
    .modal-backdrop{ position: fixed; inset: 0; background: rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index: 60; }
    .modal{ background:#fff; border-radius: 1rem; max-width: 960px; width: 95%; max-height: 90vh; overflow: auto; }
    .open{ display:flex; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <!-- Header -->
  <header class="sticky top-0 z-50 bg-white border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="/" class="font-semibold flex items-center gap-2">
        <span class="inline-flex h-9 w-9 items-center justify-center rounded-xl bg-primary-600 text-white">CF</span>
        Chamba F√°cil
      </a>
      <a href="/" class="text-sm rounded-lg border px-3 py-1.5 hover:bg-slate-50">‚Üê Volver al sitio</a>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-8">
    <div class="max-w-3xl mx-auto">
      <h1 class="text-3xl font-extrabold">Crear mi perfil</h1>
      <p class="mt-2 text-slate-600">Completa los datos para aparecer por especialidad y en el mapa ‚Äúcerca de m√≠‚Äù.</p>

      <div class="mt-4 p-4 rounded-xl bg-amber-50 border border-amber-200 text-amber-800">
        <strong>Requisito:</strong> haber realizado tu <span class="font-semibold">inscripci√≥n anual</span> ($150 MXN).
        Tu perfil quedar√° <em>pendiente de verificaci√≥n</em> hasta aprobar el pago.
      </div>

      <!-- Formulario -->
      <form id="profile-form" class="mt-6 grid gap-4 bg-white rounded-2xl p-6 shadow">
        <div class="grid md:grid-cols-2 gap-4">
          <label class="grid gap-1">
            <span class="text-sm font-medium">Nombre completo *</span>
            <input required name="name" class="rounded-xl border px-3 py-2" placeholder="Ej. Jos√© P√©rez" />
          </label>
          <label class="grid gap-1">
            <span class="text-sm font-medium">WhatsApp (10‚Äì15 d√≠gitos) *</span>
            <input required name="phone" class="rounded-xl border px-3 py-2" placeholder="Ej. 4431234567" />
          </label>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <label class="grid gap-1">
            <span class="text-sm font-medium">Especialidad *</span>
            <select required name="oficio" class="rounded-xl border px-3 py-2">
              <option value="">Selecciona...</option>
              <option>Alba√±iler√≠a</option>
              <option>Jardiner√≠a</option>
              <option>Plomer√≠a</option>
              <option>Electricidad</option>
              <option>Mec√°nicos</option>
              <option>Estilistas</option>
              <option>Cerrajeros</option>
              <option>Zapateros</option>
            </select>
          </label>
          <label class="grid gap-1">
            <span class="text-sm font-medium">Ciudad</span>
            <input name="ciudad" class="rounded-xl border px-3 py-2" placeholder="Ej. Morelia, Mich." />
          </label>
        </div>

        <label class="grid gap-1">
          <span class="text-sm font-medium">Descripci√≥n breve (m√°x. 300)</span>
          <textarea name="descripcion" maxlength="300" rows="3" class="rounded-xl border px-3 py-2" placeholder="Experiencia, servicios, garant√≠as..."></textarea>
          <small id="desc-count" class="text-slate-500 text-xs">0/300</small>
        </label>

        <div class="grid md:grid-cols-2 gap-4">
          <label class="grid gap-1">
            <span class="text-sm font-medium">Fotos de tus trabajos (hasta 3, JPG/PNG, m√°x 10MB c/u)</span>
            <input id="photos" type="file" accept="image/jpeg,image/png" multiple class="rounded-xl border px-3 py-2" />
            <small class="text-slate-500">Se recomienda subir al menos una foto.</small>
            <div id="photos-errors" class="text-red-600 text-sm"></div>
          </label>
          <div class="grid gap-2">
            <span class="text-sm font-medium">Ubicaci√≥n</span>
            <div class="flex gap-2">
              <button type="button" id="btn-geo" class="rounded-xl border px-3 py-2">üìç Usar mi ubicaci√≥n</button>
              <button type="button" id="btn-map-center" class="rounded-xl border px-3 py-2">Tomar del mapa</button>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <input id="lat" name="lat" class="rounded-xl border px-3 py-2" placeholder="Latitud" />
              <input id="lng" name="lng" class="rounded-xl border px-3 py-2" placeholder="Longitud" />
            </div>
            <small class="text-slate-500">Sugerido: marca tu zona para aparecer ‚Äúcerca de m√≠‚Äù.</small>
          </div>
        </div>

        <div id="map" class="h-64 w-full border rounded-2xl"></div>

        <fieldset class="border rounded-xl p-4 grid gap-3">
          <legend class="px-2 text-sm font-medium">Verificaci√≥n de pago</legend>
          <label class="grid gap-1">
            <span class="text-sm font-medium">Correo con el que pagaste</span>
            <input name="paymentEmail" type="email" class="rounded-xl border px-3 py-2" placeholder="tu@correo.com" />
          </label>
          <label class="grid gap-1">
            <span class="text-sm font-medium">Referencia/nota del pago</span>
            <input name="paymentRef" class="rounded-xl border px-3 py-2" placeholder="Ej. MP-1234 / SPEI 9876 / OXXO 4567" />
          </label>
          <label class="grid gap-1">
            <span class="text-sm font-medium">Comprobante (JPG/PNG/PDF, m√°x 10MB)</span>
            <input id="receipt" type="file" accept="image/jpeg,image/png,application/pdf" class="rounded-xl border px-3 py-2" />
          </label>
          <label class="flex items-center gap-2">
            <input id="declared" type="checkbox" class="rounded border" />
            <span class="text-sm">Declaro que ya pagu√© la inscripci√≥n anual de $150 MXN.</span>
          </label>
          <p class="text-xs text-slate-600">Tu perfil quedar√° <strong>pendiente</strong> hasta que un administrador verifique el pago; despu√©s aparecer√° p√∫blico.</p>
        </fieldset>

        <div class="flex items-center justify-between pt-2">
          <p id="form-msg" class="text-sm text-slate-600"></p>
          <div class="flex gap-2">
            <button type="button" id="btn-preview" class="rounded-xl border px-4 py-2">Vista previa</button>
            <button id="submit-btn" class="rounded-xl bg-primary-600 px-5 py-2.5 text-white hover:bg-primary-700">Guardar perfil</button>
          </div>
        </div>
      </form>

      <!-- Modal confirmaci√≥n -->
      <div id="confirm-modal" class="modal-backdrop">
        <div class="modal p-4 md:p-6">
          <div class="flex justify-between items-center border-b pb-3">
            <h3 class="text-xl font-semibold">Confirmar registro</h3>
            <button onclick="closeConfirm()" class="rounded-lg border px-3 py-1">Cerrar</button>
          </div>
          <div class="mt-4 grid md:grid-cols-2 gap-4">
            <div>
              <h4 class="font-semibold mb-2">Datos</h4>
              <div id="confirm-json" class="text-sm mono bg-slate-50 rounded-lg p-3 overflow-auto"></div>
            </div>
            <div>
              <h4 class="font-semibold mb-2">Checklist</h4>
              <ul class="list-disc pl-5 text-sm space-y-1">
                <li>Nombre y WhatsApp v√°lidos</li>
                <li>Especialidad seleccionada</li>
                <li>Fotos (opcional, recomendado)</li>
                <li>Ubicaci√≥n marcada (opcional, recomendado)</li>
                <li>Pago declarado y comprobante adjunto (recomendado)</li>
              </ul>
              <button id="confirm-submit" class="mt-4 rounded-xl bg-primary-600 px-4 py-2 text-white">Confirmar y guardar</button>
            </div>
          </div>
        </div>
      </div>
      <!-- /Modal -->
    </div>
  </main>

  <!-- ====== L√ìGICA MAPA Y FORM ====== -->
  <script>
    // --- Mapa ---
    let map, marker;

    function ensureMap(){
      if(map) return;
      if (!window.L) { console.warn('Leaflet a√∫n no est√° listo'); return; }
      map = L.map('map').setView([19.7008, -101.1844], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19, attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      map.on('click', (e) => {
        setLatLng(e.latlng.lat, e.latlng.lng);
        placeMarker(e.latlng.lat, e.latlng.lng);
      });
    }

    function placeMarker(lat, lng){
      if(!map) return;
      if(marker){ marker.remove(); }
      marker = L.marker([lat, lng]).addTo(map).bindPopup('Ubicaci√≥n seleccionada').openPopup();
      map.setView([lat, lng], 15);
    }

    function setLatLng(lat, lng){
      document.getElementById('lat').value = (Math.round(lat*1e6)/1e6).toString();
      document.getElementById('lng').value = (Math.round(lng*1e6)/1e6).toString();
    }

    async function getGeolocation(){
      return new Promise((res, rej) => {
        if (!navigator.geolocation) return rej(new Error('Geolocalizaci√≥n no disponible'));
        navigator.geolocation.getCurrentPosition(
          (p) => res({lat: p.coords.latitude, lng: p.coords.longitude}),
          (err) => rej(err),
          { enableHighAccuracy: true, timeout: 12000, maximumAge: 0 }
        );
      });
    }

    // Botones de ubicaci√≥n
    document.addEventListener('DOMContentLoaded', () => {
      const btnGeo = document.getElementById('btn-geo');
      const btnCenter = document.getElementById('btn-map-center');

      btnGeo?.addEventListener('click', async () => {
        try{
          const pos = await getGeolocation();
          setLatLng(pos.lat, pos.lng);
          ensureMap();
          placeMarker(pos.lat, pos.lng);
        }catch(e){ alert('Activa tu ubicaci√≥n y vuelve a intentar.'); }
      });

      btnCenter?.addEventListener('click', () => {
        ensureMap();
        if(!map) return;
        const c = map.getCenter();
        setLatLng(c.lat, c.lng);
        placeMarker(c.lat, c.lng);
      });
    });
  </script>

  <script>
    // --- Validaciones ---
    const MAX_SIZE = 10 * 1024 * 1024;

    function validatePhone(raw){
      const digits = (raw||'').replace(/\D+/g,'');
      return digits.length >= 10 && digits.length <= 15 ? digits : null;
    }
    function validatePhotos(files){
      const errs = [];
      const list = Array.from(files||[]);
      if(list.length > 3) errs.push('M√°ximo 3 fotos.');
      for(const f of list){
        if(!['image/jpeg','image/png'].includes(f.type)) errs.push(`${f.name}: formato no permitido.`);
        if(f.size > MAX_SIZE) errs.push(`${f.name}: excede 10MB.`);
      }
      return errs;
    }
    function validateReceipt(file){
      if(!file) return [];
      const okTypes = ['image/jpeg','image/png','application/pdf'];
      const errs = [];
      if(!okTypes.includes(file.type)) errs.push('Comprobante: formato no permitido.');
      if(file.size > MAX_SIZE) errs.push('Comprobante: excede 10MB.');
      return errs;
    }
  </script>

  <script>
    // --- L√≥gica de formulario ---
    const form = document.getElementById('profile-form');
    const msg = document.getElementById('form-msg');
    const btn = document.getElementById('submit-btn');
    const btnPrev = document.getElementById('btn-preview');
    const desc = document.querySelector('textarea[name=descripcion]');
    const descCount = document.getElementById('desc-count');

    desc?.addEventListener('input', () => { descCount.textContent = (desc.value||'').length + '/300'; });

    function openConfirm(){ document.getElementById('confirm-modal').classList.add('open'); }
    function closeConfirm(){ document.getElementById('confirm-modal').classList.remove('open'); }

    btnPrev.onclick = () => previewAndConfirm();
    form.addEventListener('submit', (e)=>{ e.preventDefault(); previewAndConfirm(true); });

    async function previewAndConfirm(fromSubmit=false){
      msg.textContent = '';
      const fd = new FormData(form);
      const name = (fd.get('name')||'').toString().trim();
      const phoneRaw = (fd.get('phone')||'').toString().trim();
      const phone = validatePhone(phoneRaw);
      const oficio = (fd.get('oficio')||'').toString().trim();
      const ciudad = (fd.get('ciudad')||'').toString().trim();
      const descripcion = (fd.get('descripcion')||'').toString().trim();
      const lat = parseFloat((fd.get('lat')||'').toString());
      const lng = parseFloat((fd.get('lng')||'').toString());
      const paymentEmail = (fd.get('paymentEmail')||'').toString().trim();
      const paymentRef = (fd.get('paymentRef')||'').toString().trim();
      const declared = document.getElementById('declared').checked;

      if(!name || !oficio || !phone){
        msg.textContent = 'Revisa: nombre, especialidad y WhatsApp (10‚Äì15 d√≠gitos).';
        return;
      }
      const photoInput = document.getElementById('photos');
      const photoErrs = validatePhotos(photoInput.files);
      document.getElementById('photos-errors').textContent = photoErrs.join(' ');
      if(photoErrs.length) return;

      const receiptInput = document.getElementById('receipt');
      const receiptErrs = validateReceipt(receiptInput.files[0]);
      if(receiptErrs.length){ msg.textContent = receiptErrs.join(' '); return; }

      const payload = {
        name, phone, oficio, ciudad, descripcion,
        location: (isFinite(lat) && isFinite(lng)) ? { lat, lng } : null,
        createdAt: new Date().toISOString(),
        photos: [],
        payment: {
          declared: !!declared,
          email: paymentEmail || null,
          ref: paymentRef || null,
          receiptIds: [],
          status: 'pending'
        },
        status: 'pending_review'
      };

      // Previa bonita (escapar HTML)
      const esc = (s)=>s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
      document.getElementById('confirm-json').innerHTML =
        `<pre class="mono text-xs whitespace-pre-wrap">${esc(JSON.stringify(payload, null, 2))}</pre>`;

      openConfirm();

      // Click confirmar ‚Üí guardar
      const confirmBtn = document.getElementById('confirm-submit');
      confirmBtn.onclick = async () => { await doSubmit(payload); };
    }

    async function doSubmit(payload){
      try{
        btn.disabled = true; btn.textContent = 'Guardando...';
        msg.textContent = 'Subiendo archivos‚Ä¶';

        // 1) Subir fotos a Cloudinary
        const files = Array.from(document.getElementById('photos').files||[]).slice(0,3);
        const photoIds = [];
        for(const f of files){
          const up = await uploadToCloudinary(f, 'chambafacil/profiles');
          photoIds.push(up.public_id || up.secure_url);
        }
        payload.photos = photoIds;

        // 2) Subir comprobante (opcional)
        const rfile = document.getElementById('receipt').files[0];
        if(rfile){
          const upR = await uploadToCloudinary(rfile, 'chambafacil/receipts');
          payload.payment.receiptIds = [upR.public_id || upR.secure_url];
        }

        msg.textContent = 'Guardando en base de datos‚Ä¶';

        // 3) Guardar en Firestore
        if (db) {
          await db.collection('profiles').add(payload);
          msg.textContent = '‚úÖ Perfil guardado. Quedar√° visible tras verificar el pago.';
        } else {
          msg.textContent = 'Perfil preparado (configura Firebase para guardar en base de datos).';
        }

        closeConfirm();
        btn.disabled = false; btn.textContent = 'Guardar perfil';
        form.reset();
        document.getElementById('desc-count').textContent = '0/300';
        alert('‚úÖ Tu perfil se registr√≥. Te notificaremos cuando est√© verificado.');
      }catch(err){
        console.error(err);
        msg.textContent = 'Ocurri√≥ un error al guardar. Intenta de nuevo.';
        btn.disabled = false; btn.textContent = 'Guardar perfil';
      }
    }
  </script>

  <!-- Modal confirmaci√≥n (contenedor) -->
  <div id="confirm-modal" class="modal-backdrop">
    <div class="modal p-4 md:p-6">
      <div class="flex justify-between items-center border-b pb-3">
        <h3 class="text-xl font-semibold">Confirmar registro</h3>
        <button onclick="closeConfirm()" class="rounded-lg border px-3 py-1">Cerrar</button>
      </div>
      <div class="mt-4 grid md:grid-cols-2 gap-4">
        <div>
          <h4 class="font-semibold mb-2">Datos</h4>
          <div id="confirm-json" class="text-sm mono bg-slate-50 rounded-lg p-3 overflow-auto"></div>
        </div>
        <div>
          <h4 class="font-semibold mb-2">Checklist</h4>
          <ul class="list-disc pl-5 text-sm space-y-1">
            <li>Nombre y WhatsApp v√°lidos</li>
            <li>Especialidad seleccionada</li>
            <li>Fotos (opcional, recomendado)</li>
            <li>Ubicaci√≥n marcada (opcional, recomendado)</li>
            <li>Pago declarado y comprobante adjunto (recomendado)</li>
          </ul>
          <button id="confirm-submit" class="mt-4 rounded-xl bg-primary-600 px-4 py-2 text-white">Confirmar y guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- LAZY-INIT DEL MAPA: pegar siempre al final, antes de analytics -->
  <script>
    // Crea el mapa del admin SOLO cuando el contenedor entra al viewport
    function initAdminMapWhenVisible(){
      const target = document.getElementById('map');
      if (!target) return;

      if ('IntersectionObserver' in window){
        const io = new IntersectionObserver((entries) => {
          if (entries.some(e => e.isIntersecting)){
            ensureMap();     // usa tu ensureMap existente
            io.disconnect(); // ya no necesitamos observar
          }
        }, { rootMargin: '200px 0px' }); // inicia un poco antes de que sea visible
        io.observe(target);
      } else {
        // Fallback para navegadores antiguos
        ensureMap();
      }
    }

    // En lugar de llamar ensureMap() en DOMContentLoaded, llamamos al lazy-init:
    window.addEventListener('DOMContentLoaded', initAdminMapWhenVisible);
  </script>

  <!-- Analytics (GA4) -->
  <script src="/js/analytics.js" data-ga-id="G-RY7GC75EPC"></script>
</body>
</html>
