<!doctype html>
<html lang="es"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin ‚Äî Chamba F√°cil</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
</head>
<body class="antialiased text-slate-800">
<main class="mx-auto max-w-3xl p-6">
  <h1 class="text-3xl font-bold">Admin ‚Äî Perfiles</h1>
  <p class="mt-2 text-slate-600">Sube fotos firmadas a Cloudinary y crea perfiles en Firestore con ubicaci√≥n y categor√≠a.</p>

  <section class="mt-6 rounded-2xl border bg-white p-5">
    <h2 class="text-xl font-semibold">Config</h2>
    <div class="grid gap-3 md:grid-cols-2 mt-3">
      <textarea id="firebase" rows="6" class="w-full rounded-xl border px-3 py-2" placeholder='{"apiKey":"...","authDomain":"...","projectId":"...","appId":"..."}'></textarea>
      <input id="api" class="w-full rounded-xl border px-3 py-2" placeholder="https://tu-api.onrender.com">
    </div>
    <button id="init" class="mt-3 rounded-xl bg-slate-900 px-4 py-2 text-white">Inicializar</button>
    <div id="initStatus" class="mt-2 text-sm text-slate-600"></div>
  </section>

  <section class="mt-6 rounded-2xl border bg-white p-5">
    <h2 class="text-xl font-semibold">Subir fotos</h2>
    <input id="files" type="file" accept="image/*" multiple class="mt-2 w-full rounded-2xl border px-3 py-2">
    <button id="upload" class="mt-3 rounded-xl bg-primary-600 px-4 py-2 text-white">Subir (m√°x 3)</button>
    <div id="photos" class="mt-3 text-sm"></div>
  </section>

  <section class="mt-6 rounded-2xl border bg-white p-5">
    <h2 class="text-xl font-semibold">Crear perfil</h2>
    <div class="grid gap-3 md:grid-cols-3">
      <input id="name" class="rounded-xl border px-3 py-2" placeholder="Nombre">
      <select id="oficio" class="rounded-xl border px-3 py-2">
        <option value="">Selecciona un oficio</option>
        <option>Alba√±iler√≠a</option>
        <option>Jardiner√≠a</option>
        <option>Plomer√≠a</option>
        <option>Electricidad</option>
        <option>Mec√°nicos</option>
        <option>Estilistas</option>
        <option>Cerrajeros</option>
        <option>Zapateros</option>
      </select>
      <input id="ciudad" class="rounded-xl border px-3 py-2" placeholder="Ciudad">
    </div>

    <div class="mt-4 grid gap-3 md:grid-cols-3">
      <input id="lat" class="rounded-xl border px-3 py-2" placeholder="Latitud">
      <input id="lng" class="rounded-xl border px-3 py-2" placeholder="Longitud">
      <button id="btn-mypos" class="rounded-xl border px-3 py-2">üìç Usar mi ubicaci√≥n</button>
    </div>
    <div id="map-admin" class="mt-3 h-72 w-full rounded-2xl border"></div>

    <button id="save" class="mt-4 rounded-xl bg-primary-600 px-4 py-2 text-white">Guardar perfil</button>
    <div id="saveStatus" class="mt-2 text-sm text-slate-600"></div>
  </section>

  <p class="mt-6"><a href="./index.html" class="text-blue-600 underline">Volver</a></p>
</main>

<script>
let db=null, apiBase='', uploaded=[];
document.getElementById('init').onclick=()=>{
  try{
    const cfg=JSON.parse(document.getElementById('firebase').value.trim());
    firebase.initializeApp(cfg); db=firebase.firestore();
    apiBase=document.getElementById('api').value.trim().replace(/\/$/,'');
    document.getElementById('initStatus').textContent='Inicializado';
    initAdminMap();
  }catch(e){
    document.getElementById('initStatus').textContent='Error: '+e.message;
  }
};

document.getElementById('upload').onclick=async()=>{
  if (!apiBase){ alert('Coloca la URL del servidor (API)'); return; }
  const files=[...document.getElementById('files').files].slice(0,3);
  if(!files.length){ alert('Selecciona im√°genes'); return; }
  const sig=await fetch(apiBase+'/api/signature').then(r=>r.json());
  if(!sig.signature){ alert('Firma no disponible'); return; }
  uploaded=[];
  for(const f of files){
    const fd=new FormData();
    fd.append('file',f);
    fd.append('api_key',sig.apiKey);
    fd.append('timestamp',sig.timestamp);
    const res=await fetch(`https://api.cloudinary.com/v1_1/${sig.cloudName}/image/upload?signature=${sig.signature}`,{method:'POST',body:fd});
    const data=await res.json();
    if(data.public_id){ uploaded.push(data.public_id); }
  }
  document.getElementById('photos').innerHTML='<strong>public_ids:</strong> '+uploaded.join(', ');
};

// Mapa admin
let mapA, markerA;
function initAdminMap(){
  if (mapA) return;
  mapA = L.map('map-admin').setView([19.7008, -101.1844], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'&copy; OpenStreetMap' }).addTo(mapA);
  markerA = L.marker([19.7008, -101.1844], { draggable:true }).addTo(mapA);
  markerA.on('dragend', ()=>{
    const p=markerA.getLatLng();
    document.getElementById('lat').value=p.lat.toFixed(6);
    document.getElementById('lng').value=p.lng.toFixed(6);
  });
  mapA.on('click', e=>{
    markerA.setLatLng(e.latlng);
    document.getElementById('lat').value=e.latlng.lat.toFixed(6);
    document.getElementById('lng').value=e.latlng.lng.toFixed(6);
  });
}
document.getElementById('btn-mypos').onclick=async()=>{
  try{
    const pos=await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(p=>res({lat:p.coords.latitude,lng:p.coords.longitude}),rej,{enableHighAccuracy:true,timeout:8000}));
    markerA.setLatLng(pos); mapA.setView(pos,15);
    document.getElementById('lat').value=pos.lat.toFixed(6);
    document.getElementById('lng').value=pos.lng.toFixed(6);
  }catch(e){ alert('Activa tu ubicaci√≥n y vuelve a intentar.'); }
};

document.getElementById('save').onclick=async()=>{
  if(!db){ alert('Inicializa Firebase'); return; }
  const name=document.getElementById('name').value.trim();
  const oficio=document.getElementById('oficio').value.trim();
  const ciudad=document.getElementById('ciudad').value.trim();
  const lat=parseFloat(document.getElementById('lat').value);
  const lng=parseFloat(document.getElementById('lng').value);
  if(!name||!oficio||!ciudad){ alert('Completa campos'); return; }
  if(Number.isNaN(lat)||Number.isNaN(lng)){ alert('Define la ubicaci√≥n en el mapa.'); return; }
  const doc={ name, oficio, ciudad, location:{lat,lng}, photos: uploaded, rating:4.5, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
  await db.collection('profiles').add(doc);
  document.getElementById('saveStatus').textContent='Perfil guardado con ubicaci√≥n y categor√≠a.';
};
</script>
</body></html>
