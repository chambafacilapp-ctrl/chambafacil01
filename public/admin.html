<!doctype html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Chamba F√°cil ‚Äî Admin (crear perfil)</title>
  <meta name="description" content="Crea y edita tu perfil para aparecer en el mapa de Chamba F√°cil.">
  <link rel="icon" type="image/png" href="/favicon-32.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: { primary: {500:'#f97316',600:'#ea580c',700:'#c2410c'} } } } }
  </script>

  <!-- Leaflet (para vista previa del punto) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <style>
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:1rem; padding:1rem; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <script>
    // Gate simple: si no hay pago confirmado, regresar al flujo previo
    (function(){
      const paid = localStorage.getItem('cf_paid_annual') === 'true';
      if (!paid) location.href = '/pago-previo.html';
    })();
  </script>

  <header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <a href="/" class="font-semibold flex items-center gap-2">
        <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-primary-600 text-white">CF</span> Chamba F√°cil ‚Äî Admin
      </a>
      <nav class="text-sm">
        <a href="/" class="hover:text-primary-600">Inicio</a>
      </nav>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6">
    <div class="grid lg:grid-cols-3 gap-6">
      <section class="lg:col-span-2 card">
        <h1 class="text-2xl font-bold">Crear mi perfil</h1>
        <p class="text-slate-600 mb-4">Completa tu informaci√≥n. M√°s adelante conectaremos directamente con Firestore y Mercado Pago.</p>

        <form id="profile-form" class="grid md:grid-cols-2 gap-4">
          <div class="md:col-span-2">
            <label class="block text-sm font-medium">Nombre completo</label>
            <input id="name" type="text" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="Ej: Juan P√©rez" required>
          </div>

          <div>
            <label class="block text-sm font-medium">Especialidad</label>
            <select id="oficio" class="mt-1 w-full rounded-xl border px-3 py-2" required>
              <option value="">Selecciona‚Ä¶</option>
              <option>Alba√±iler√≠a</option>
              <option>Jardiner√≠a</option>
              <option>Plomer√≠a</option>
              <option>Electricidad</option>
              <option>Mec√°nicos</option>
              <option>Estilistas</option>
              <option>Cerrajeros</option>
              <option>Zapateros</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium">Ciudad</label>
            <input id="ciudad" type="text" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="Ej: Morelia, Mich." required>
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-medium">Descripci√≥n</label>
            <textarea id="descripcion" rows="3" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="Servicios que realizas, experiencia, etc."></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium">Tel√©fono (WhatsApp)</label>
            <input id="phone" type="tel" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="10 d√≠gitos" required>
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-medium">Fotos (IDs de Cloudinary) ‚Äî opcional</label>
            <div class="grid md:grid-cols-3 gap-2 mt-1">
              <input id="photo1" class="rounded-xl border px-3 py-2" placeholder="ej: sample">
              <input id="photo2" class="rounded-xl border px-3 py-2" placeholder="ej: sample2">
              <input id="photo3" class="rounded-xl border px-3 py-2" placeholder="ej: sample3">
            </div>
            <p class="text-xs text-slate-500 mt-1">Usaremos Cloudinary (formato: solo el public_id). M√°s tarde habilitaremos carga directa.</p>
          </div>

          <div class="md:col-span-2 card">
            <div class="flex items-center justify-between mb-2">
              <div>
                <h2 class="font-semibold">Ubicaci√≥n</h2>
                <p class="text-sm text-slate-600">Coloca tu punto para aparecer en el mapa.</p>
              </div>
              <button id="btn-geo" type="button" class="rounded-xl border px-3 py-2">üìç Usar mi ubicaci√≥n</button>
            </div>
            <div class="grid md:grid-cols-3 gap-3">
              <label class="text-sm">Lat
                <input id="lat" type="number" step="any" class="w-full rounded-xl border px-3 py-2 mt-1" placeholder="19.7008">
              </label>
              <label class="text-sm">Lng
                <input id="lng" type="number" step="any" class="w-full rounded-xl border px-3 py-2 mt-1" placeholder="-101.1844">
              </label>
              <button id="btn-preview" type="button" class="rounded-xl bg-primary-600 text-white px-3 py-2 mt-6">Vista previa en mapa</button>
            </div>
            <div id="map" class="h-64 w-full rounded-xl border mt-3"></div>
          </div>

          <div class="md:col-span-2 flex gap-3">
            <button id="btn-save-local" type="button" class="rounded-xl bg-primary-600 text-white px-4 py-2">Guardar local (pruebas)</button>
            <button id="btn-export-json" type="button" class="rounded-xl border px-4 py-2">Exportar JSON</button>
          </div>
        </form>
      </section>

      <aside class="card">
        <h2 class="text-lg font-semibold mb-2">Estado</h2>
        <ul class="text-sm text-slate-600 space-y-1">
          <li>‚úî Acceso permitido (pago marcado en este dispositivo)</li>
          <li>‚ö† A√∫n sin sincronizaci√≥n en la nube (Firestore)</li>
          <li>üì∏ Cloudinary pronto con subida directa</li>
        </ul>
        <hr class="my-4">
        <h3 class="font-semibold mb-2">Ayuda r√°pida</h3>
        <p class="text-sm">Si cambias de dispositivo, vuelve a <a class="text-primary-600 hover:underline" href="/pago-previo.html">marcar pago</a> para entrar.</p>
      </aside>
    </div>
  </main>

  <script>
    // Lazy init del mapa (cuando entra a viewport)
    let map, marker;
    function ensureMap(){
      if (map) return;
      map = L.map('map').setView([19.7008, -101.1844], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(map);
    }
    const obs = new IntersectionObserver(entries => {
      entries.forEach(e => { if (e.isIntersecting) { ensureMap(); obs.disconnect(); } });
    }, { rootMargin: '100px' });
    obs.observe(document.getElementById('map'));

    function updateMarker(lat, lng){
      ensureMap();
      if (marker) { map.removeLayer(marker); }
      marker = L.marker([lat, lng]).addTo(map).bindPopup('Tu ubicaci√≥n');
      map.setView([lat, lng], 14);
    }

    document.getElementById('btn-geo').addEventListener('click', async () => {
      if (!navigator.geolocation) return alert('Geolocalizaci√≥n no disponible');
      navigator.geolocation.getCurrentPosition(p => {
        const lat = p.coords.latitude, lng = p.coords.longitude;
        document.getElementById('lat').value = lat.toFixed(6);
        document.getElementById('lng').value = lng.toFixed(6);
        updateMarker(lat, lng);
      }, () => alert('Activa tu ubicaci√≥n e int√©ntalo de nuevo'), { enableHighAccuracy:true, timeout:10000 });
    });

    document.getElementById('btn-preview').addEventListener('click', () => {
      const lat = parseFloat(document.getElementById('lat').value);
      const lng = parseFloat(document.getElementById('lng').value);
      if (Number.isFinite(lat) && Number.isFinite(lng)) updateMarker(lat, lng);
      else alert('Lat/Lng inv√°lidos');
    });

    // Guardado local para pruebas (no persiste en el sitio p√∫blico)
    document.getElementById('btn-save-local').addEventListener('click', () => {
      const data = readForm();
      if (!data) return;
      // Guarda en localStorage como arreglo de "drafts"
      const drafts = JSON.parse(localStorage.getItem('cf_admin_drafts') || '[]');
      drafts.push(data);
      localStorage.setItem('cf_admin_drafts', JSON.stringify(drafts));
      alert('Borrador guardado localmente (no subido). M√°s adelante se enviar√° a Firestore.');
    });

    document.getElementById('btn-export-json').addEventListener('click', () => {
      const data = readForm();
      if (!data) return;
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'perfil_chambafacil.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    function readForm(){
      const name = (document.getElementById('name').value || '').trim();
      const oficio = document.getElementById('oficio').value;
      const ciudad = (document.getElementById('ciudad').value || '').trim();
      const descripcion = (document.getElementById('descripcion').value || '').trim();
      const phone = (document.getElementById('phone').value || '').replace(/\D+/g,'');
      const photos = [ 'photo1', 'photo2', 'photo3' ].map(id => document.getElementById(id).value.trim()).filter(Boolean);
      const lat = parseFloat(document.getElementById('lat').value);
      const lng = parseFloat(document.getElementById('lng').value);

      if (!name || !oficio || !ciudad) { alert('Completa nombre, especialidad y ciudad.'); return null; }
      if (!/^[0-9]{7,15}$/.test(phone)) { alert('Tel√©fono inv√°lido (solo d√≠gitos, 7-15).'); return null; }
      if (!Number.isFinite(lat) || !Number.isFinite(lng)) { alert('Coloca tu ubicaci√≥n (lat/lng).'); return null; }

      return {
        ownerUid: 'local-user', // temporal
        name, oficio, ciudad, descripcion, phone,
        photos,
        location: { lat, lng },
        public: true,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
    }
  </script>
</body>
</html>
